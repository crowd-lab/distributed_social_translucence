<html>
  <head>
    <title>Work Page</title>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
      {% if condition == "exp" %}
      <script src='{{ url_for('static', filename='js/togetherjs.js') }}'></script>
        {% if edge_case == 'First' %}
        <style>
          /* Hiding togetherjs elements for first moderator (edge case) */
          #togetherjs-container, #togetherjs-dock {
            display: none !important;
          }
        </style>
        {% endif %}
      <script>
        // TogetherJS configurations
        var TogetherJSConfig_findRoom = '{{ room_name }}';
        var TogetherJSConfig_autoStart = true;
        var TogetherJSConfig_suppressJoinConfirmation = true;
        var TogetherJSConfig_disableWebRTC = true;
        var TogetherJSConfig_includeHashInUrl = false;
        {% if edge_case == 'First' %}
          var TogetherJSConfig_cloneClicks = false;
          var TogetherJSConfig_dontShowClicks = true;
        {% endif %}
      </script>
      {% endif %}
  </head>
  <body>
    <div style='height: 100%; display: flex;'>
      <div>
        <!-- Moderator interface -->
        <p id='counter_text' style='text-align: center;'></p>
        <button id='moderate_submit_button' style='display: none;' {% if condition == "exp" %}disabled{% else %}onclick='window.location.href = "/consent"'{% endif %}>Submit Decisions</button>
        {% if condition == 'exp' %}
        <button id='moderate_done_button' style='display: none;' {% if page == "moderation" %}onclick='window.location.href = "/consent"'{% endif %}>Continue</button>
        {% endif %}
        <div id="image-carousel" class="carousel" data-wrap=false data-interval=false>
          <div class="carousel-inner">
			      {% for i in range(img_count) %}
            <div class="carousel-item {% if i == 0 %} active{% endif %}">
              <div id='moderate' class="btn-group-toggle" data-toggle="buttons">
                <label class="btn"><input type="radio" name="options-{{ i }}">No</label>
                <label class="btn"><input type="radio" name="options-{{ i }}">Yes</label>
              </div>
              <img src='{{ imgs[i] }}' style='max-width: 50%;'>
            </div>
						{% endfor %}
          </div>
          <a class="carousel-control-prev" style='display: none;' href="#image-carousel" role="button" data-slide="prev">
            <span>Previous</span>
          </a>
          <a class="carousel-control-next" {% if img_count == 1 %}style="display: none;"{% endif %} href="#image-carousel" role="button" data-slide="next">
            <span>Next</span>
          </a>
        </div>
      </div>
      <!-- Observer interface -->
      {% if page == "observation" %}
      <div style='background-color: grey;'>
        <div>
      {% else %}
      <div class='col-md-4'>
        <div style='display: none;'>
      {% endif %}
          <form action='javascript:submitObservations()'>
            <label for='observations'>Please describe what you see the moderator doing</label>
            <textarea id='observations' rows='25'></textarea>
            <button id='observe_button' type='submit'>Submit Observations</button>
            <button id='observe_continue_button' type='button' onclick='window.location.href = "/wait"' disabled>Continue</button>
          </form>
        </div>
      </div>
    </div>
  </body>
  <script>
    // Not allowing observer to interact with the moderator interface
    {% if page == "observation" %}
    $('#image-carousel, #moderate_submit_button, #moderate_done_button').on('click', '*', function(e) {
      if(!e.originalEvent.togetherjsInternal === true) {
        return false;
      }
    });
    $('.moderate_submit_button').prop('disabled', true);
    {% endif %}

    // Initializing variables for image moderation
    var choices = [{% for i in range(img_count) %}{% if(i != 0) %},{% endif %}0{% endfor %}];
    var cur_index = 0;
    var num_images = {{ img_count }};

    // Setting counter text on load
    $(document).ready(function() {
      $('#counter_text').text('Image ' + (cur_index + 1) + ' of ' + num_images);
    });

    // Image carousel functionality
    $('.carousel-control-next').prop('disabled', true);
    $('#image-carousel').on('slid.bs.carousel', function(e) {
      cur_index = e.to;
      $('#counter_text').text('Image ' + (cur_index + 1) + ' of ' + (num_images)); // Update current image counter

      // Hide previous button on first image
      if(cur_index == 0) {
        $('.carousel-control-prev').hide();
      } else {
        $('.carousel-control-prev').show();
      }

      // Hide next button on last image
      if(cur_index == num_images - 1) {
        $('.carousel-control-next').hide();
      } else {
        $('.carousel-control-next').show();
      }

      // Disable next button if no choice has been recorded
      if(choices[cur_index] == 0) {
          $('.carousel-control-next').prop('disabled', true);
      } else {
          $('.carousel-control-next').prop('disabled', false);
      }
    });

    // Choice selection
    $('.btn-group-toggle').on('click', function (e) {
      choices[cur_index] = e.target.innerText;
      $('.carousel-control-next').prop('disabled', false);
      if(choices.indexOf(0) === -1) {
        $('#moderate_submit_button').show(); // Reveal submit button after all choices are made
      }
    });

    // Moderator submission
    {% if page == "moderation" %}
    $('#moderate_submit_button').on('click', function() {
      var submission = {
        decisions : choices,
        img_ids : [
        {% for i in range(img_count) %}
          {% if i != 0 %},{% endif %}{{ img_ids[i] }}
        {% endfor %}],
        pair_id : {{ pair_id }}
      };

      $.ajax({
        url: '/submit_mods',
        data: JSON.stringify(submission),
        contentType: 'application/json;charset=UTF-8',
        type: 'POST'
      });

      $('#moderate_submit_button').prop('disabled', true);
      $('#moderate_done_button').show();
    });
    {% endif %}

    // Polling for observer submission
    {% if condition == "exp" %}
    var obsSubmitted = false;
    var pair_id_json = { pair_id : {{ pair_id }} };
    function checkObsSubmitted() {
      $.ajax({
        url: '/check_obs_submitted',
        data: JSON.stringify(pair_id_json),
        contentType: 'application/json;charset=UTF-8',
        type: 'POST',
        success: function(data) {
          if(data.status == 'success') {
            if(data.submitted == 'true' && !obsSubmitted) {
              obsSubmitted = true;
              $('#moderate_submit_button').prop('disabled', false);
            }
          }
        }
      });

      if(!obsSubmitted) setTimeout(checkObsSubmitted, 2000);
    }
    checkObsSubmitted();
    {% endif %}

    {% if page == "observation" %}
    // Observer submission
    function submitObservations() {
      var submission = {
        pair_id : {{ pair_id }},
        obs_text : $('#observations').val()
      };

      $.ajax({
        url: '/submit_obs',
        data: JSON.stringify(submission),
        contentType: 'application/json;charset=UTF-8',
        type: 'POST'
      });

      $('#observe_button').prop('disabled', true);
    }

    // Polling for moderator submission
    var modSubmitted = false;
    var pair_id_json = { pair_id : {{ pair_id }} };
    function checkModSubmission() {
      $.ajax({
        url: '/check_mod_submitted',
        data: JSON.stringify(pair_id_json),
        contentType: 'application/json;charset=UTF-8',
        type: 'POST',
        success: function(data) {
          if(data.status == 'success') {
            if(data.submitted == 'true' && !modSubmitted) {
              modSubmitted = true;
              $('#observe_continue_button').prop('disabled', false);
              $('#moderate_submit_button').prop('disabled', true);
              $('#moderate_done_button').show();
            }
          }
        }
      });

      if(!modSubmitted) setTimeout(checkModSubmission, 2000);
    }
    checkModSubmission();
    {% endif %}
  </script>
</html>
