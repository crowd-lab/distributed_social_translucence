<html>
  <head>
      <title>Wait Page</title>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
      <script>
        var partnerReady = false;

        function goToWork() {
            window.location.href = '/work';
        }

        {% if role == 'mod' %}
        function political_affiliation() {
          var political = $("input[name='political']:checked").val();
          if(political === undefined) {
            return
          }
          if(political === 'Other') {
            political = 'Other: ' + $("input[name='other']").val();
          }
          var out_data = {'political': political, 'turk_id': "{{ turk_id }}"};
          console.log(out_data)
          $.ajax({
            url: '/political_affiliation',
            type: 'POST',
            data: JSON.stringify(out_data),
            contentType: 'application/json;charset=UTF-8',
            dataType: 'json',
            success: function(data) {
              console.log(out_data)
              $('#political_form :input').prop("disabled", true);
              $('#form_submit').prop("disabled", true)
            }
          });
          return
        }
        {% endif %}

        function pollWorkReady() {
          var pairData = {'pair_id': {{ pair_id }}};

          $.ajax({
            url: '/poll_work_ready',
            type: 'POST',
            data: JSON.stringify(pairData),
            contentType: 'application/json;charset=UTF-8',
            dataType: 'json',
            success: function(data) {
              if(data.status == 'success') {
                {% if role == 'obs' %}
                    goToWork();
                {% else %}
                    if($('#form_submit').is(':disabled')){
                      setTimeout(goToWork(), 2000);
                    } else {
                      partnerReady = true;
                      alert("Work is ready, please fill out the form first.");
                    }
                {% endif %}
              } else {
                  setTimeout(pollWorkReady, 2000);
              }
            }
          });
          return;
        }
        $(document).ready(pollWorkReady());
      </script>
      <script>
        // TogetherJS configurations
        TogetherJSConfig_autoStart = true;
        TogetherJSConfig_findRoom = '{{ room_name }}';
        TogetherJSConfig_suppressJoinConfirmation = true;
        TogetherJSConfig_disableWebRTC = true;
        TogetherJSConfig_includeHashInUrl = false;
        TogetherJSConfig_cloneClicks = true;
        TogetherJSConfig_dontShowClicks = true;
        TogetherJSConfig_ignoreForms = true;

        window.sessionStorage.removeItem('togetherjs-session.status')
        window.sessionStorage.removeItem('togetherjs-session.peerCache')
      </script>
      <script src='{{ url_for('static', filename='js/togetherjs.js') }}'></script>
      <style>
        #togetherjs-container, .togetherjs-cursor {
          display: none !important;
        }
      </style>
      <link rel='stylesheet' href='{{ url_for('static', filename='css/fix.css') }}'></script>
  </head>
  <body>
    <p>Please wait until you are transferred to the task. You will be compensated for waiting.</p>
    {% if role == 'mod' %}
    <p>What is your political affiliation:</p>
    <form id='political_form'>
        <input type='radio' name='political' value='Liberal'>Liberal
        <input type='radio' name='political' value='Conservative'>Conservative
        <input type='radio' name='political' value='Other'> Other <input type='text' name='other' />
      </form>
      <button id='form_submit' onclick='political_affiliation(); if(partnerReady) goToWork();'>Submit</button>
    {% endif %}
  </body>
</html>
